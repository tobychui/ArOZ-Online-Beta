<html>
    <head>
        <title>File Explorer</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
        <link rel="stylesheet" href="../../script/tocas/tocas.css">
        <script type="text/javascript" src="../../script/tocas/tocas.js"></script>
        <script type="text/javascript" src="../../script/jquery.min.js"></script>
        <script type="text/javascript" src="../../script/ao_module.js"></script>
        <script>
             window.mobilecheck = function() {
                var check = false;
                (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
                return check;
            };
        </script>
        <style>
            body{
                color:black;
                height:100%;
            }
            @font-face {
                font-family: 'TaipeiSansTCBeta-Regular';
                src: url('../../script/font/TaipeiSansTCBeta-Regular.ttf');
            }
            h1, h2, h3, p, span, div,span { font-family: 'TaipeiSansTCBeta-Regular'}
            html{
                height:100%;
                overflow:hidden;
            }
            body.whiteTheme{
                background-color:rgb(250, 250, 250);
            }
            .darkTheme{
                background-color:#242330 !important;
                color:white;
            }
            .whiteTheme{
                color:#0d0d0d
            }
            .navibar{
                position:fixed;
                width:100%;
                padding-left:12px;
                padding-right:12px;
                padding-top:6px;
                padding-bottom:3px;
                z-index: 99;
            }
            .navibar.darkTheme{
                background-color:#17161f !important;
                border-bottom:2px solid #34b7eb;

            }
            .navibar.whiteTheme{
                /*box-shadow: 0 2px 4px 2px rgb(224, 224, 224);*/
                background-color:#fcfcfc;
                border-bottom:2px solid #34b7eb;
            }
            .whiteTheme .button.standard{
                box-shadow: 0 1px 1px 0px rgb(190, 190, 190);
                border: 0px;
            }

            .whiteTheme .button.standard:hover{
                background-color:#82c2f0 !important;
                color:white !important;
            }

            .ts.button{
                margin-bottom:2px;
            }

            .ts.button.darkTheme{
                background-color:#17161f !important;
                border: 1px solid #262533;
                color:white;
            }

            .ts.button.darkTheme:hover{
                background-color:#312f42 !important;
                color:white !important;
            }

            .rightPad{
                margin-right:40px;
            }
            .addressBar{
                width:100%;
                padding:3px;
                min-height: 35px;
                padding-top:6px;
            }
            .breadcrumb.darkTheme{
                background-color:transparent;
            }
            .section.darkTheme{
                color:white !important;
                background-color:transparent;
            }
            .selectable{
                cursor:pointer;
            }
            .rightAlign{
                position:absolute;
                right:0px;
                top:3px;
            }
            .addressText{
                padding:5px;
                border-radius: 3px;
            }
            .addressText.darkTheme{
                border: 1px solid #262533;
            }
            .addressText.whiteTheme{
                border: 1px solid #cfcfcf;
            }
            .divider.whiteTheme{
                color:#262533 !important;
                background-color:transparent;
            }
            .divider.darkTheme{
                background-color:transparent;
                color: white !important;
            }
            #directorySidebar{
                padding:12px;
                overflow-y:auto;
                padding-bottom:20px;
            }
            #directorySidebar.darkTheme{
                border-right:2px solid rgb(25, 24, 31);
                color:white;
                position:absolute;
            }
            #directorySidebar.whiteTheme{
                border-right:2px solid rgba(219, 226, 241, 0.7);
                background-color:#f5f5f5;
                color:rgb(44, 44, 44);
                position:absolute;
            }
            #folderView{
                position:absolute;
                padding-left:2em;
                padding-right:2em;
                padding-top:2em;
                overflow-y:auto;
            }
            #folderView.whiteTheme{
                background-color:white;
            }
            .item.darkTheme{
                color:white;
            }
            .rightmargin.icon{
                margin-right:8px !important;
            }
            .dir{
                cursor:pointer;
            }
            .dir:hover{
                color:#d1d1d1 !important;
            }
            .dir.item.whiteTheme{
                color:rgb(78, 78, 78);
            }
            .device{
                cursor:pointer;
            }
            .device:hover{
                color:#d1d1d1;
            }
            .accordion.darkTheme{
                color:white !important;
            }
            .accordion.whiteTheme{
                background-color:transparent !important;
            }
            .fileObject{
                display:block !important;
                cursor:pointer;
                overflow-wrap: break-word !important;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            .fileObject.darkTheme{
                border:1px solid rgb(72, 69, 88) !important;
            }
            .segmented.list.darkTheme{
                border:1px solid rgb(8, 8, 10) !important;
                box-shadow: 0 0 0 0;
                border-radius: 0px;
            }
            .fileObject.darkTheme:hover{
                background-color:#17161f !important;
            }
            .fileObject.whiteTheme:hover{
                background-color:#f2f2f2 !important;
            }
            .fileObject.darkTheme.selected{
                background-color:#100f16 !important;
                
            }
            .fileObject.whiteTheme.selected{
                background-color:#d2f2f7 !important;
                color:black !important;
            }
            .mobilePathDisplayWrapper{
                width:100%;
                margin-bottom:5px;
            }
            .ts.card.darkTheme{
                border:1px solid rgb(72, 69, 88) !important;
                box-shadow: 0 0 0 0 transparent;
            }
            .darkTheme.header{
                color:white !important;
                background-color:transparent !important;
            }
            .darkTheme.meta{
                color:rgba(255, 255, 255, 0.836) !important;
                background-color:transparent !important;
            }
            .darkTheme.description{
                color:white !important;
                background-color:transparent !important;
            }
            .whiteTheme.header{
                background-color:transparent;
            }
            .whiteTheme.meta{
                background-color:transparent;
            }
            .whiteTheme.description{
                background-color:transparent;
            }
            #folderList{
                margin-bottom:16px;
            }
            .msgbox{
                padding:3px;
            }
            .closeMsgButton{
                position:absolute;
                top:4px;
                right:12px;

            }
            .closeMsgButton{
                cursor:pointer;
            }
            .popup{
                position:fixed;
                top:30px;
                z-index:110;
                left:34%;
                right:34%;
                bottom:30px;
                border-radius: 8px;
                padding-bottom:24px;
            }

            .popup.darkTheme{
                -webkit-box-shadow: 3px 4px 5px 0px rgb(35, 33, 46) ;
                -moz-box-shadow: 3px 4px 5px 0px rgb(35, 33, 46);
                box-shadow: 3px 4px 5px 0px rgb(35, 33, 46) ;
                border: 1px solid rgb(22, 21, 29);
            }

            .popup.whiteTheme{
                -webkit-box-shadow:  3px 4px 5px 0px rgba(138,138,138,1);
                -moz-box-shadow:  3px 4px 5px 0px rgba(138,138,138,1);
                box-shadow:  3px 4px 5px 0px rgba(138,138,138,1);
                border: 1px solid rgb(226, 226, 226);
                background-color:white;
            }

            @media only screen and (max-width: 1920px) {
                .popup{
                    left:35em;
                    right:35em;
                }
            }

            @media only screen and (max-width: 1500px) {
                .popup{
                    left:20em;
                    right:20em;
                }
            }
            
            
            @media only screen and (max-width: 1200px) {
                .popup{
                    left:14em;
                    right:14em;
                }
            }

            @media only screen and (max-width: 800px) {
                .popup{
                    left:5em;
                    right:5em;
                }
            }

            @media only screen and (max-width: 600px) {
                .popup{
                    position:fixed;
                    top:5%;
                    z-index:100;
                    left:1em;
                    right:1em;
                }
            }

            .popupheader{
                width:100%;
                padding:3px;
                padding-left:12px;
                border-bottom:2px solid #34b7eb;
                height:29px;
            }

            .popupcontent{
                height: calc(100% - 29px);
                overflow:auto;
            }

            .popupheader.whiteTheme{
                background-color:#eee;
                color: #232322;
            }
            .popupheader.darkTheme{
                background-color:#111017 !important;
                color: white;
            }

            .popupcloser{
                position:absolute;
                top:5px;
                right:0px;
                cursor:pointer;
            }

            .popupbuttons{
                cursor:pointer;
                padding:5px;
                padding-left:12px;
                margin-bottom:4px;
                border: 1px solid #dedede;
                border-radius: 4px;
            }

            .popupbuttons.primary.whiteTheme{
                background-color:#51aded;
                box-shadow: 0 2px 1px 0px #34a2ee !important;
                border: 1px solid transparent;
                color:white;
            }

            .popupbuttons.primary.darkTheme{
                background-color:#413f57 !important;
                box-shadow: 0 2px 1px 0px #3c3b50 !important;
                border: 1px solid transparent;
                color:white;
            }

            .popupbuttons.disabled{
               opacity: 0.4;
               pointer-events: none;
            }

            .popupbuttons.primary.disabled{
                opacity: 0.4;
                pointer-events: none;
            }

            .whiteTheme.allowHover:hover{
                background-color:rgba(238, 238, 238, 0.932);
            }

            .whiteTheme.allowHover.primary:hover{
                background-color:#76c0f5;
            }

            .darkTheme.allowHover:hover{
                background-color:#111017 !important;
            }

            .ts.list.darkTheme{
                background-color:#464457 !important;
            }

            input.darkTheme{
                color:white !important;
            }

            .ts.segmented.list.darkTheme .item{
                color:white !important;
            }
            .newFileFormat{
                cursor:pointer;
            }
          
            .popupWrapper{
                position:fixed;
                top:0px;
                left:0px;
                width:100%;
                height:100%;
                z-index:99;
                background-color:rgba(27,27,27,0.5);
                display:none;
            }
            @supports (backdrop-filter: none) {
                .popupWrapper {
                    backdrop-filter: blur(5px);
                }
            }
            .breadcrumb.whiteTheme{
                background-color:white;
            }

            #openWithModuleList{
                height:250px;
                overflow-y:auto;
            }

            #openWith .segment.darkTheme{
                color:white !important;
            }

            #openWithModuleList .item{
                padding:8px;
                padding-left:22px;
                border-radius: 2px;
                display: flex;
                flex-wrap: wrap;        
            }

            #openWithModuleList.darkTheme .item.selected{
                background-color:#100f16 !important;
            }
            #openWithModuleList.whiteTheme .item.selected{
                background-color:#51aded !important;
                color:white;
            }
     
            #openWithModuleList.darkTheme .item.selectable:hover{
                background-color:rgba(250,250,250,0.05);
            }
            #openWithModuleList.whiteTheme .item.selectable:hover{
                background-color:rgba(35,35,35,0.14);
            }
            .contextmenu.darkTheme .item{
                color:white !important;
            }

            .contextmenu .item{
                font-size:90% !important;
            }

            #uploadTab{
                position:fixed;
                right:0px;
                bottom: 0px;
                width:300px;
                margin-bottom:0px !important;
                padding:0px !important;
            }

            #uploadTab.darkTheme{
               color:white;
               background-color:rgba(35,35,35,0.14);
               border: 1px solid #17161f !important;
               box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.75);
            }

            .statusBar{
                height:32px;
                background-color:#f5f5f5;
                padding:8px;
            }

            .statusBar.whiteTheme{
                color:rgb(78, 78, 78);
            }

            .statusBar.darkTheme{
                background-color:#181720 !important;
            }

            .hideUploadButton{
                float: right;
                cursor:pointer;
            }

            .uploadList{
                margin:8px;
                padding-bottom:3px;
                margin-bottom:0px;
                max-height: 250px;
                overflow-y:auto;
            }

            .uploadTask{
                margin-top:6px;
            }
            .uploadTaskRemoveIcon{
                position:absolute;
                top:0px;
                right:0px;
                cursor:pointer;
            }
            .clearallButton{
                padding:8px;
                cursor:pointer;
            }

            .normal.object.whiteTheme{
                color:#303030;
            }

            .normal.object.darkTheme{
                color:white;
            }

            .hex.foldername{
                color:#2b9447 !important;
            }

            .um.filename{
                color: #69aaff !important;
            }
        </style>
    </head>
    <body class="whiteTheme">
        <div id="navibar" class="navibar whiteTheme">
            <!-- Directoy navigations -->
            <button id="backbtn" class="ts icon tiny button standard whiteTheme" onclick="previosPath();" title="Back"><i class="left arrow icon"></i></button>
            <button id="ppbtn" class="ts icon tiny button standard whiteTheme rightPad" onclick="parentDir();" title="Parent Folder"><i class="up arrow icon"></i></button>
            
            <!-- File Read Operations -->
            <button class="ts icon tiny button standard whiteTheme" title="Open" onclick="openViaButton();"><i class="folder open icon"></i></button>
            <button class="ts icon tiny button standard whiteTheme" title="Open with" onclick="openWith();"><i class="external icon"></i></button>
            <button class="ts labeled icon tiny button standard whiteTheme" style="width:154px;"  title="Download" onclick="downloadFile();">
                <i class="download icon"></i>
                Download
            </button>

             <!-- File Edit Operations -->
             <button class="ts icon tiny button standard whiteTheme" title="Copy" onclick="copy();"><i class="copy icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="Paste" onclick="paste();"><i class="paste icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="Cut" onclick="cut();"><i class="cut icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="New File" onclick="newfile();"><i class="file outline icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="New Folder" onclick="newFolder();"><i class="folder outline icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="Upload" onclick="upload();"><i class="upload icon"></i></button>

             <button class="ts icon tiny button standard whiteTheme" title="Rename" onclick="rename();"><i class="i cursor icon"></i></button>
             <button class="ts icon tiny negative button" title="Delete" onclick="deleteFile();"><i class="trash outline icon"></i></button>

             <button class="ts icon tiny button standard whiteTheme" title="Refresh" onclick="refreshList();"><i class="refresh icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="File Info" onclick="showFileProperties();"><i class="notice icon"></i></button>
             <button class="ts icon tiny button standard whiteTheme" title="Help"><i class="help icon"></i></button>
             
             <div class="addressBar">
                <button class="ts icon tiny button standard whiteTheme" onclick="toggleSidebar();"  title="Toggle Folder List"><i class="content icon"></i></button>
                <button  class="ts icon tiny button inverted" title="Dark Theme" onclick="toggleDarkTheme();"><i class="moon icon" id="darkthemebtn"></i></button>
                <div class="ts breadcrumb whiteTheme addressText pathDisplay desktopOnly">
                    <div class="section whiteTheme selectable"><i class="folder icon"></i> user</div>
                    <div class="divider whiteTheme">:/</div>
                    <div class="section whiteTheme selectable">Desktop</div>
                </div>
                <div class="rightAlign">
                    <button class="ts icon tiny button standard whiteTheme"  title="Search"><i class="search icon"></i></button>
                    <button class="ts icon tiny button standard whiteTheme videmode" mode="grid" title="Block View" onclick="changeViewMode(this);"><i class="block layout icon"></i></button>
                    <button class="ts icon tiny button standard whiteTheme videmode" mode="list" title="List View" onclick="changeViewMode(this);"><i class="align justify icon"></i></button>
                    <!-- <button class="ts icon tiny button whiteTheme videmode" mode="details" title="Details View"><i class="list icon"></i></button> -->
                </div>
             </div>
             <div class="mobilePathDisplayWrapper">
                <div style="width:100%;" class="ts pathDisplay breadcrumb whiteTheme addressText mobileOnly">
                    <div class="section wh onclick="refreshList();"iteTheme selectable"><i class="folder icon"></i> user</div>
                    <div class="divider whiteTheme">:/</div>
                    <div class="section whiteTheme selectable">Desktop</div>
                </div>
             </div>
             <div class="msgbox" style="z-index:999; display:none;">
                <i class="checkmark icon"></i> <span>No Message</span>
                <div class="closeMsgButton" onclick="$(this).parent().slideUp('fast');"><i class="remove icon"></i></div>
            </div>
        </div>
       
        <div id="mainWindow">
            <div id="directorySidebar" class="whiteTheme">
                <div class="ts list">
                    <details class="ts accordion fluid whiteTheme" open>
                        <summary>
                            <i class="dropdown icon"></i> User
                        </summary>
                        <div id="userroot" class="ts list" style="padding-top:0px !important;">
                            <div class="dir item whiteTheme"><i class="loading circle notched rightmargin icon"></i> Initiating</div>
                        </div>
                    </details>
                    <details class="ts accordion fluid whiteTheme" open>
                        <summary>
                            <i class="dropdown icon"></i> Storage
                        </summary>
                        <div id="storageroot" class="ts list" style="padding-top:0px !important;">
                            <div class="dir item whiteTheme"><i class="loading circle notched rightmargin icon"></i> Initiating</div>
                        </div>
                    </details>
                    <!-- 
                    <details class="ts accordion fluid whiteTheme" open>
                        <summary>
                            <i class="caret down icon"></i>Disks
                        </summary>
                        <div id="deviceList" class="ts list" style="padding-top:0px !important;">
                            <div class="dir item whiteTheme"><i class="loading circle notched rightmargin icon"></i> Initiating</div>
                        </div>
                    </details>
                    -->
                    <!-- >
                    <div class="item fluid whiteTheme">
                        <i class="world icon"></i>Network
                    </div>
                     -->     
                    <br>
                </div>
            </div>
            <div id="folderView" class="whiteTheme" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div id="folderList">

                </div>
                <div id="fileList">

                </div>
                <br>
            </div>
        </div>
        <!-- Other popup windows -->
        <div class="popupWrapper"></div>
        <!-- Overwrite Selection Box-->
        <div id="overwriteModeSelection" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="paste icon"></i> Replace, Keep or Skip Files
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <small style="font-size:80%;">Copying <span class="owm-fc"></span> files from <span class="owm-srcdir"></span> to <span class="owm-destdir"></span>.</small>
                <p>The destination has <span class="owm-fc"></span> files with the same names.</p>

                <div class="popupbuttons whiteTheme allowHover primary" onclick="changeOverwriteRule(0,true);">
                    <i class="checkmark icon"></i> Replace the files in the destination
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="changeOverwriteRule(1,true);">
                    <i class="reply icon"></i> Skip these files
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="changeOverwriteRule(2,true);">
                    <i class="undo icon"></i> Rename and keep the files
                </div>
            </div>
        </div>
        <!-- Force delete confirmation box -->
        <div id="forceDeleteConfirmBox" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="trash icon"></i> Permanently Remove Files
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <p>Are you sure you want to remove these files <u>permanently?</u><br>This action is <u>irreversible</u>.</p>
                <div class="ts list whiteTheme deleteFilelist" style="max-height:350px;overflow-y:auto; ">

                </div>
                <div class="popupbuttons whiteTheme allowHover" style="background-color: #eb4034 !important;" onclick="forceDelete(true);";>
                <i class="trash icon"></i> Confirm
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="cancelForceDelete();hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>

            </div>
        </div>

        <!-- Delete confirm box -->
        <div id="deleteConfirmBox" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="recycle icon"></i> Move files to Trash Bin
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <p>Are you sure you want to move these files to trash bin?</p>
                <div class="ts list whiteTheme deleteFilelist" style="max-height:350px;overflow-y:auto; ">

                </div>
                <div class="popupbuttons whiteTheme allowHover" style="color: #2bbbdf !important;" onclick="deleteFile(true);";>
                <i class="recycle icon"></i> Move to Trash
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="cancelDelete();hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>

            </div>
        </div>

        <!-- Rename tool box -->
        <div id="renameBox" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="text cursor icon"></i> Rename Files
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <p>Enter the new filename for renaming. </p>
                <p class="multifileWarning"><i class="notice icon"></i> Other files will be named as file(#)</p>
                <div class="ts left icon small fluid input" style="margin-bottom:12px;">
                    <input type="text" class="whiteTheme orgfn" placeholder="Original Filename" readonly="true">
                    <i class="minus square icon" style="color:rgb(122, 176, 247)"></i>
                </div>
                <div class="ts left icon small fluid input" style="margin-bottom:12px;">
                    <input type="text" class="whiteTheme newfn" placeholder="New Filename" onkeydown="handleEnterKeyDown(event, function(){confirmRename(true);})">
                    <i class="add square icon" style="color:rgb(122, 176, 247)"></i>
                </div>
                <div class="popupbuttons whiteTheme allowHover primary"  onclick="confirmRename(true);";>
                <i class="checkmark icon"></i> OK
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>

            </div>
        </div>

        <!-- New File Dialog-->
        <div id="newFile" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="add icon"></i> New File
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <p>Please select a type of file to be created.</p>
                <div class="ts segmented list whiteTheme newfilelist" style="max-height:18em; overflow-y:scroll">
                    <div class="item newFileFormat" ext="php">No Item</div>
                </div>
                <p>Or create an empty file with given filename:</p>
                <div class="ts left icon small fluid input" style="margin-bottom:12px;">
                    <input id="createNewFileName" type="text" class="whiteTheme" placeholder="New Filename" onkeydown="handleEnterKeyDown(event, confirmNewFile);">
                    <i class="add square icon" style="color:rgb(122, 176, 247)"></i>
                </div>
                <p class="duplicateWarning" style="color:#CE5F58; display:none;"><i class="caution sign icon"></i> The given filename already exist.</p>
                <div class="popupbuttons whiteTheme allowHover primary"  onclick="confirmNewFile();";>
                    <i class="add icon"></i> Create
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>
            </div>
        </div>

        <!-- New Folder Dialog-->
        <div id="newFolder" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="folder icon"></i> New Folder
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
                <p>Please enter the new folder name to be created.</p>
                <div class="ts left icon small fluid input" style="margin-bottom:12px;">
                    <input id="createNewFolder" type="text" class="whiteTheme" placeholder="New Folder Name" onkeydown="handleEnterKeyDown(event, function(){newFolder(true);});">
                    <i class="add square icon" style="color:rgb(122, 176, 247)"></i>
                </div>
                <p class="duplicateWarning" style="color:#CE5F58; display:none;"><i class="caution sign icon"></i> The given folder already exist.</p>
                <div class="popupbuttons whiteTheme allowHover primary"  onclick="newFolder(true);";>
                    <i class="add icon"></i> Create
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>
            </div>
        </div>

        <!-- Open With Dialog-->
        <div id="openWith" class="popup whiteTheme" style="display:none;">
            <div class="popupheader whiteTheme">
                <i class="external icon"></i> Open File With
                <div class="popupcloser" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i>
                </div>
            </div>
            <div class="popupcontent" style="padding:12px;">
               <p>Select a module from the list below:</p>
                <div id="openWithModuleList" class="ts segment whiteTheme" style="padding:0px;">
                    <div class="item selectable">
                        <div class="content" style="padding-left:12px;">
                            <div class="header">Loading...</div>
                        </div>
                    </div>
                </div>
                <div class="openWithModule popupbuttons whiteTheme allowHover primary" onclick="openWithSelectedModule(this);";>
                    <i class="external icon"></i> Open with Selected Module
                </div> 
                <div class="openWithModule popupbuttons whiteTheme allowHover" onclick="openFileWithModuleInNewTab(this);">
                    <i class="add icon"></i> Open in new tab
                </div>
                <div class="popupbuttons whiteTheme allowHover vdonly" onclick="openRawFileInFloatWindow(this);">
                    <i class="window restore outline icon"></i> Open File directly in floatWindow
                </div>
                <div class="popupbuttons whiteTheme allowHover" onclick="hideAllPopupWindows();">
                    <i class="remove icon"></i> Cancel
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div id="contextmenu" class="ts small contextmenu visible whiteTheme" style="min-width:250px;">
            <div class="item" onclick="openViaButton();">
                <i class="folder open icon"></i>  Open
            </div>
            <div class="item" onclick="openWith();">
                <i class="external icon"></i> Open With
            </div>
            <div class="item" onclick="copy();">
                <i class="copy icon"></i> Copy
                <span class="description">Ctrl + C</span>
            </div>
            <div class="item" onclick="paste();">
                <i class="paste icon"></i> Paste
                <span class="description">Ctrl + V</span>
            </div>
            <div class="item" onclick="cut();">
                <i class="cut icon"></i> Cut
                <span class="description">Ctrl + X</span>
            </div>
            <div class="divider"></div>
            <div class="item" onclick="newfile();">
                <i class="file outline icon"></i>  New File
            </div>
            <div class="item" onclick="newFolder();">
                <i class="folder outline icon"></i> New Folder
            </div>
            <div class="divider"></div>
            <div class="item" onclick="upload();">
                <i class="upload icon"></i>  Upload
            </div>
            <div class="item" onclick="rename();">
                <i class="i cursor icon"></i> Rename
            </div>
            <div class="item" onclick="deleteFile();">
                <i class="trash icon"></i> Delete
            </div>
            <div class="divider"></div>
            <div class="item" onclick="downloadFile();">
                <i class="download icon"></i> Download
            </div>
            <div class="item" onclick="showFileProperties();">
                <i class="notice icon"></i> Properties
            </div>
        </div>

        <!-- Upload Progress Bars-->
        <div id="uploadTab" class="ts segment whiteTheme" style="display:none;">
            <div class="statusBar whiteTheme">
                <i class="upload icon"></i> Uploading <span id="uploadCount">0</span> Files
                <div class="hideUploadButton" onclick="toggleUploadList();">
                    <i class="caret down icon"></i>
                </div>
            </div>
            <div class="uploadList" id="uploadProgressList">
              
            </div>
            <div class="clearallButton">
                <a onclick="clearAllUploadTask();">Clear All</a>
            </div>
            
        </div>

           
        <script>
            var directorySidebarWidth = 250; //Width of the sidebar
            var sideBarShown = true; //Indicate if sidebar is shown
            var rootDirs = [];  //Storage location for rootDirs
            var currentTheme = "whiteTheme"; //Default theme
            var viewMode = "list"; //Viewmode, support {list, grid, detail}
            var sortMode = "default"; //Sortmode, support {default, reverse, smallToLarge, largeToSmall}
            var currentPath = "user:/"
            var viewHistory = []; //View history
            var isMobile = window.mobilecheck();
            var isChromium = window.chrome;
            var enableBetaFilename = true; //Enable beta filename conversion from "inith..." to "normal"
            var currentFilelist = []; //The current file list in the currentPath
             
            //File operations
            var clipboard = []; //System clipboard
            var cutMode = false; //If set to true, this is cut mode. Else copy mode
            var useLocalstorage = lscheck();
            var overwriteMode = "keep"; //Overwrite mode, support {skip, overwrite, keep}

            //Keypress listeners
            var ctrlHold = false;
            var shiftHold = false;

            //Upload related
            var uploadingFileCount = 0;
            
            //System Information
            var systemUUID = "";
            var systemIP = "";

            //Intiiation functions
            initRootDirs();
            initSystemInfo();

            if (isMobile){
                //Mobile css adjustment
                sideBarShown = false;
                $("#directorySidebar").hide();
                $("#directorySidebar").css("width",window.innerWidth + "px");
                $("body").css("overflow","hidden");
                directorySidebarWidth = window.innerWidth;
                $("#folderView").css({
                    "padding-right":"1em",
                    "padding-left":"1em",
                    "padding-top":"1em",
                });
                $(".desktopOnly").hide();
                $(".mobileOnly").show();
            }else{
                $(".mobileOnly").hide();
                $(".desktopOnly").show();
            }
            //Initialize view mode buttons
            updateViewmodeButtons();

            //Initialize system theme
            loadPreference("file_explorer/theme",function(data){
                if (data.error === undefined){
                    if (data == "darkTheme"){
                        toggleDarkTheme();
                    }else{
                        //White theme. Do nothing
                    }
                }
            });

            if (window.location.hash != ""){
                //Check if the hash is standard open protocol. If yes, translate it
                if (ao_module_loadInputFiles() === null){
                    //Window location hash set. List the desire directory
                    currentPath = window.location.hash.substring(1,window.location.hash.length);
                    if (currentPath.substring(currentPath.length -1) != "/"){
                        currentPath = currentPath + "/";
                    }
                }else{
                    //This is ao_module load file input. Handle the file opening
                    var filelist = ao_module_loadInputFiles();
                    if (filelist.length > 0){
                        filelist = filelist[0];
                        //Check if this is folder or file. Only opendir when it is folder
                        if (filelist.filename.includes(".") == false){
                            //Try to open it and overwrite the hash to filesystem hash
                            listDirectory(filelist.filepath);
                        }

                    }
                }
            }

            //Get list mode from storage
            loadPreference("file_explorer/listmode",function(data){
                if (data != "" && data.error === undefined){
                    viewMode = data;
                    updateViewmodeButtons();
                }

                //Initialized directory views
                listDirectory(currentPath);
            });

            //Get the system ID and ip address from the system id services
            function initSystemInfo(){
                $.get("../../system/id/requestInfo",function(data){
                    if (data.error !== undefined){
                        msgbox("remove", data.error);
                    }else{
                        systemUUID = data.SystemUUID;
                        systemIP = data.IpAddress;
                    }
                });
            }

            //Initiate the sidebar contents 
            function initRootDirs(){
                //Load user directories
                $.ajax({
                    url:"../../system/file_system/listRoots?user=true",
                    success: function(data){
                        $("#userroot").html("");
                        for (var i =0; i < data.length; i++){
                            var thisRootObject = data[i];
                            if (thisRootObject.IsDir == true){
                                //Files will not be listed in the root directory list
                                var icon = getUserRootIcons(thisRootObject.Filename);
                                var displayName = thisRootObject.Filename;
                                var vpath = thisRootObject.Filepath;
                                $("#userroot").append(`<div class="dir item ${currentTheme}" filepath="${vpath}" type="folder" onclick="openthis(this);"><i class="${icon} rightmargin icon"></i> ${displayName}</div>`);
                            }
                        }
                    }   
                });

                //Load other storage devices
                $.ajax({
                    url:"../../system/file_system/listRoots",
                    success: function(data){
                        $("#storageroot").html("");
                        for (var i =0; i < data.length; i++){
                            var thisRoot = data[i];
                            var displayName = thisRoot.RootName;
                            var rootPath = thisRoot.RootPath;
                            $("#storageroot").append(`<div class="dir item ${currentTheme}" filepath="${rootPath}" type="folder" rootname="${displayName}" onclick="openthis(this);"><i class="disk outline rightmargin icon"></i> ${displayName} (${rootPath})</div>`);
                        }
                    }
                });

                //Initial Host device drives
                /*
                $.ajax({
                    url: "../../system/file_system/listDrives",
                    success: function(data){
                        $("#deviceList").html("");
                        for (var i =0; i < data.length; i++){
                            var drivePath = data[i].Drivepath;
                            var usagePercentage = ((data[i].DriveTotalSpace - data[i].DriveFreeSpace) / data[i].DriveTotalSpace) * 100;
                            var className = "primary";
                            if (usagePercentage > 90){
                                className = "negative";
                            }
                            $("#deviceList").append(`<div class="dir item ${currentTheme}" filepath="${drivePath}" ><i class="disk outline rightmargin icon"></i> ${drivePath} 
                                <div style="width:100px;height:15px !important; position:absolute;right:3px;top:6px;"">
                                    <div class="ts ${className} tiny progress">
                                        <div class="bar" style="width: ${usagePercentage}%"></div>
                                    </div>
                                </div>
                                </div>`);
                        }
                    }
                });
                */
            }

          

            function getUserRootIcons(foldername){
                var icon = "folder open";
                if (foldername == "Desktop"){
                    icon = "computer";
                }else if (foldername == "Document"){
                    icon = "file text outline";
                }else if (foldername == "Music"){
                    icon = "music";
                }else if (foldername == "Photo"){
                    icon = "image";
                }else if (foldername == "Video"){
                    icon = "video";
                }else if (foldername == "Trash"){
                    icon = "trash"
                }
                return icon;
            }

            // ============================== FOLDER LISTING FUNCTIONS ====================
            function listDirectory(path){
                //Always pad slash to the end of path
                if (path.substring(path.length - 1) != "/"){
                    path = path + "/";
                }
                path = decodeURIComponent(path);
                viewHistory.push(path);
                window.location.hash = path;
                updatePathDisplay(path);
                currentPath = path;
                //Update floatWindow title if exists
                if (ao_module_virtualDesktop){
                    var tmp = path.split("/");
                    tmp.pop();
                    ao_module_setWindowTitle("File Manager - " + tmp.pop());
                }
                //Check if there are parent path for curret path
                if (checkIfParentDirExists(currentPath)){
                    $("#ppbtn").removeClass("disabled");
                }else{
                    $("#ppbtn").addClass("disabled");
                }
                if (viewHistory.length <= 1){
                    $("#backbtn").addClass("disabled");
                }else{
                    $("#backbtn").removeClass("disabled");
                }

                $.ajax({
                    url: "../../system/file_system/listDir",
                    method: "POST",
                    data: {dir: encodeURIComponent(path), sort: sortMode},
                    success: function(data){
                        //Parse the filelist into global variable
                        currentFilelist = [];
                        if (data === null){
                            //There is nothing is this folder.
                            $("#folderList").hide();
                            $("#fileList").hide();
                            return;
                        }
                        $("#fileList").html("");
                        $("#folderList").html("");
                        //Build the css strcture of the list
                        if (viewMode == "list"){
                            $("#fileList").attr("class",`ts segmented fluid list ${currentTheme}`);
                            $("#folderList").attr("class",`ts segmented fluid list ${currentTheme}`);
                        }else if (viewMode == "details"){
                            
                        }else if (viewMode == "grid"){
                            $("#fileList").attr("class",`${currentTheme}`).css("vertical-align","top");
                            $("#folderList").attr("class",`${currentTheme}`).css("vertical-align","top");
                        }
                    
                        var files = [];
                        var folders = [];
                        for (var i =0; i < data.length; i++){
                            if (data[i].IsDir == true){
                                //This is folder
                                folders.push(data[i]);
                            }else{
                                //This is file
                                files.push(data[i]);
                            }
                            currentFilelist.push(JSON.parse(JSON.stringify(data[i].Filename)));
                        }
                        //Define the grid size for the interface
                        var gridSize = window.innerWidth / 7 ;
                        if (isMobile){
                            gridSize = window.innerWidth /2 - 20 ;
                        }
                        if (gridSize > 150 && !isMobile){
                            gridSize = 150;
                        }
                        //List all folders
                        for (var i =0; i < folders.length; i++){
                            var filename = folders[i].Filename;
                            var filepath = folders[i].Filepath;
                            var realpath = folders[i].Realpath;
                            var isDir = folders[i].IsDir;
                            var filesize = folders[i].Filesize;
                            var Displaysize = folders[i].Displaysize;
                            var ext = getExtFromPath(filepath);
                            //var icon = ao_module_utils.getIconFromExt(ext);
                            var icon = "folder";
                            if (viewMode == "list"){
                                var textclass = "normal object";
                                if (currentTheme == "darkTheme"){
                                    textclass += " darkTheme";
                                }
                                var displayName = filename;
                                if (enableBetaFilename && ao_module_codec.decodeHexFoldername(displayName) != displayName){
                                    displayName = ao_module_codec.decodeHexFoldername(displayName, false);
                                    textclass = "hex foldername";
                                }
                                $("#folderList").append(`<div class="fileObject item ${currentTheme}" draggable="true" ondragstart="onFileObjectDragStart(this,event);" ondrop="dropToFolder(event)" ondragover="allowDrop(event)" fileID="${i}" filename="${filename}" filepath="${filepath}" ondblclick="openthis(this,event);" type="folder"><span style="display:inline-block !important;word-break: break-all;" class="${textclass}"><i class="${icon} icon" style="margin-right:12px;"></i>  ${displayName}</span></div>`);
                            }else if (viewMode == "grid"){
                                var displayName = JSON.parse(JSON.stringify(filename));
                                var textclass = "normal object";
                                if (enableBetaFilename && ao_module_codec.decodeHexFoldername(displayName) != displayName){
                                    displayName = ao_module_codec.decodeHexFoldername(displayName, false);
                                    textclass = "hex foldername";
                                }
                                if (displayName.length > 16){
                                    displayName = displayName.substring(0,16) + "...";
                                }
                                $("#folderList").append(`
                                <div class="ts card fileObject ${currentTheme}" draggable="true" ondragstart="onFileObjectDragStart(this,event);" ondrop="dropToFolder(event)" ondragover="allowDrop(event)" fileID="${i}" filename="${filename}" filepath="${filepath}" ondblclick="openthis(this,event);" type="folder" style="width:${gridSize}px; display:inline-block !important;vertical-align:top; height:15em; margin-top:0px !important; overflow:hidden;">
                                    <div class="image">
                                        <img  draggable="true"ondragstart="disableDrag(event);" src="../../../img/desktop/system_icon/folder.png">
                                    </div>
                                    <div class="content">
                                        <div class="header ${currentTheme} ${textclass}">${displayName}</div>
                                    </div>
                                </div>`);
                            }
                        }
                        if (folders.length == 0){
                            $("#folderList").hide();
                        }else{
                            $("#folderList").show();
                        }
                    
                        //List all files
                        var fl = folders.length;
                        for (var i =0; i < files.length; i++){
                            var filename = files[i].Filename;
                            var filepath = files[i].Filepath;
                            var realpath = files[i].Realpath;
                            var filesize = files[i].Filesize;
                            var Displaysize = files[i].Displaysize;
                            var ext = getExtFromPath(filepath);
                            if (ext == ""){
                                var icon = "file outline";
                            }else{
                                var icon = ao_module_utils.getIconFromExt(ext);
                            }
                            
                            if (viewMode == "list"){
                                var displayName = filename;
                                var textclass = "normal object";
                                if (currentTheme == "darkTheme"){
                                    textclass += " darkTheme";
                                }
                                if (enableBetaFilename){
                                    decodedName = ao_module_codec.decodeUmFilename(displayName);
                                    if (decodedName != displayName){
                                        displayName = decodedName;
                                        textclass = "um filename";
                                    }
                                    filename = ao_module_codec.decodeUmFilename(filename);
                                }
                                $("#fileList").append(`<div class="fileObject item ${currentTheme}" draggable="true" ondragstart="onFileObjectDragStart(this,event);"  fileID="${fl + i}"  filename="${filename}" filepath="${filepath}" ondblclick="openthis(this,event);"  type="file" filesize="${filesize}" displaysize="${Displaysize}"><span style="display:inline-block !important;word-break: break-all;text-overflow: ellipsis !important;overflow: hidden;" class="${textclass}"><i class="${icon} icon" style="margin-right:12px;"></i>  ${displayName}</span></div>`);
                            }else if (viewMode == "grid"){
                                var imagePath = "../../../img/desktop/files_icon/default/" + icon + ".png";
                                var displayName = JSON.parse(JSON.stringify(filename));
                                var textclass = "normal object";
                                if (enableBetaFilename){
                                    decodedName = ao_module_codec.decodeUmFilename(displayName);
                                    if (decodedName != displayName){
                                        textclass = "um filename";
                                        displayName = decodedName;
                                    }
                                    filename = ao_module_codec.decodeUmFilename(filename);
                                }
                                
                                if (displayName.length > 20){
                                    displayName = displayName.substring(0,20) + "...";
                                }
                                $("#fileList").append(`
                                <div class="ts card fileObject ${currentTheme}" draggable="true" ondragstart="onFileObjectDragStart(this,event);" fileID="${fl + i}" filename="${filename}" filepath="${filepath}" ondblclick="openthis(this,event);" type="file" style="width:${gridSize}px; display:inline-block !important;vertical-align:top; height:20em;  margin-top:0px !important;  overflow:hidden;">
                                    <div class="image">
                                        <img draggable="true"ondragstart="disableDrag(event);" src="${imagePath}">
                                    </div>
                                    <div class="content">
                                        <div class="header ${currentTheme} ${textclass}" style="text-overflow: ellipsis;">${displayName}</div>
                                        <div class="meta ${currentTheme}">
                                            <div>.${ext}</div>
                                        </div>
                                        <div class="description ${currentTheme}">
                                            ${Displaysize}
                                        </div>
                                    </div>
                                </div>
                                `);
                            }
                        }
                        if (files.length == 0){
                            $("#fileList").hide();
                        }else{
                            $("#fileList").show();
                        }

                        bindFileObjectEvents();
                    }
                });
            }

            //Make an div not draggable
            function disableDrag(event){
                event.preventDefault();
                event.stopPropagation();
            }

            //Make fileObject draggable
            function onFileObjectDragStart(object, event){
                if ((ctrlHold) &&  $(object).hasClass("selected") == false){
                    $(object).addClass("selected");
                }else if ($(object).hasClass("selected") == false){
                    $(".fileObject.selected").removeClass("selected");
                    $(object).addClass("selected");
                }

                var fileList = [];
                $(".selected.fileObject").each(function(){
                    var filename = $(this).attr('filename');
                    var filepath = $(this).attr('filepath');
                    var sourceSystemUUID = systemUUID;
                    //Extra information is passed in due to the need for cross cluster communication in the future
                    fileList.push({
                        filename: filename,
                        filepath: filepath,
                        hostUUID: sourceSystemUUID
                    });
                });
               
                event.dataTransfer.setData("filedata", JSON.stringify(fileList));
            }

            //Bind onclicke events for fileObjects
            var lastClickedFileID = 0;
            function bindFileObjectEvents(){
                $(".fileObject").off("click").on('click',function(evt){
                    if (ctrlHold == true){
                        if ($(this).hasClass("selected")){
                            $(this).removeClass("selected");
                        }else{
                            $(this).addClass("selected");
                        }
                       
                        lastClickedFileID = parseInt($(this).attr("fileid"));
                    }else if (shiftHold == true){
                        //Select everything in range lastClicked to this
                        var thisFileID = $(this).attr("fileid");
                        let start = parseInt(thisFileID);
                        let end = parseInt(lastClickedFileID);
                        if (start > end){
                            start = parseInt(lastClickedFileID);
                            end = parseInt(thisFileID);
                        }
                        //Select all fileObject in range.
                        $(".fileObject").each(function(){
                            let currentItemFileID = $(this).attr('fileid');
                            currentItemFileID = currentItemFileID - 0;
                            if (currentItemFileID >= start && currentItemFileID <= end){
                                $(this).addClass("selected");
                            }
                        });

                    }else{
                        //Nothing is pressed. Deselect everything and add this only
                        $(".fileObject.selected").removeClass("selected");
                        $(this).addClass("selected");
                        lastClickedFileID = $(this).attr("fileID");
                    }
                });

                //Bind right click select on items
                $(".fileObject").off("mousedown").on("mousedown",function(evt){
                    if (evt.which == 3){
                        //Right click on this file
                        if ($(this).hasClass('selected') == false){
                            $(".fileObject.selected").removeClass("selected");
                            $(this).addClass("selected");
                        }
                    }
                });

                $(".fileObject").off("contextmenu").on("contextmenu", function(evt){
                    evt.preventDefault();
                    if (evt.pageY < window.innerHeight / 2){
                        $("#contextmenu").css({
                            left: evt.pageX,
                            top: evt.pageY
                        });
                    }else{
                        $("#contextmenu").css({
                            left: evt.pageX,
                            top: evt.pageY - $("#contextmenu").height() + "px"
                        });
                    }
                    $("#contextmenu").addClass("visible");
                    //Handle CSS offset of the contextmenu
                    if ($("#contextmenu").offset().top < 0){
                        $("#contextmenu").css("top","0px");
                    }else if($("#contextmenu").offset().top + $("#contextmenu").height() > window.innerHeight){
                        $("#contextmenu").css("top",window.innerHeight - $("#contextmenu").height() + "px");
                    }

                });

               $(document).on("click",function(evt){
                   $(".contextmenu").removeClass("visible");
               });

                //Force overwrite css
                /*
                $(".ts.contextmenu .item").css({
                    'cssText':"padding: 8px !important"
                });
                */
            }

            //Change the current view mode
            function changeViewMode(object){
                var targetMode = $(object).attr("mode");
                viewMode = targetMode;
                listDirectory(currentPath);
                updateViewmodeButtons();
                setPreference("file_explorer/listmode",targetMode)
            }

            function updateViewmodeButtons(){
                $(".videmode").removeClass('disabled');
                $(".videmode").each(function(){
                    if ($(this).attr("mode") == viewMode){
                        $(this).addClass("disabled");
                    }
                });
            }

            function previosPath(){
                //Remove the current directory from history
                if (viewHistory.length == 1){
                    //This is already the first page
                    return;
                }
                viewHistory.pop();
                var previousPath = viewHistory.pop();
                listDirectory(previousPath);
            }

            function parentDir(){
                //Check if there are any parent dir for this path
                if (checkIfParentDirExists(currentPath)){
                    //There are parent path. Get it from currentPath
                    pathInfo = currentPath.split("/");
                    pathInfo.pop();
                    pathInfo.pop();
                    parentPath = pathInfo.join("/") + "/"
                    
                    //List the parentDir
                    listDirectory(parentPath);
                }

            }

            function rootDir(){
                //Go to the root dir of the current path
                var rootDir = currentPath.split("/").shift();
                rootDir = rootDir + "/";
                listDirectory(rootDir);
            }

            function checkIfParentDirExists(path){
                if (path.includes("/")){
                    pathInfo = path.split("/");
                    if (pathInfo[1] == ""){
                        return false;
                    }else{
                        return true;
                    }
                }else{
                    return false;
                }
            }

            //=================================== FILE OPERATIONS ========================

            function refreshList(){
                shiftHold = false;
                ctrlHold = false;
                listDirectory(currentPath);
            }

            let renameFileObjects = [];
            function rename(){
                $(".popup").fadeOut('fast');
                renameFileObjects = [];
                var filenames = [];
                $(".fileObject.selected").each(function(){
                    var fileObjectType = $(this).attr("type");
                    let fileObject = {
                        filename: $(this).attr('filename'),
                        filepath: $(this).attr("filepath"),
                        filetype: fileObjectType
                    }
                    renameFileObjects.push(JSON.parse(JSON.stringify(fileObject)));
                    filenames.push($(this).attr('filename'));
                });
                var oldname = "unknown file.txt";
                if (renameFileObjects.length == 0){
                    return;
                }else if (renameFileObjects.length > 0){
                    $("#renameBox").find(".multifileWarning").hide();
                    oldname = filenames[0];
                }
                $("#renameBox").find(".orgfn").val(oldname);
                $("#renameBox").find(".newfn").val(oldname);
                showPopupWrapper();
                $("#renameBox").fadeIn(100);
            }

            function confirmRename(){
                var oldName = $("#renameBox").find(".orgfn").val();
                var newName = $("#renameBox").find(".newfn").val();
                if (newName == oldName){
                    msgbox("remove","New filename is identical to the original filename.")
                    $("#renameBox").fadeOut(100);
                    return;
                }
                var newNameWithoutExt = newName;
                var newnameExt = "";
                if (newName.includes(".")){
                    tmp = newName.split(".");
                    newnameExt = tmp.pop();
                    newNameWithoutExt = tmp.join(".");
                }

                var counter = 0;
                var srclist = [];
                var newnamelist = [];

                for (var i =0; i < renameFileObjects.length; i++){
                    var thisFilepath = renameFileObjects[i].filepath;
                    var thisFiletype = renameFileObjects[i].filetype;
                    var thisFilename = renameFileObjects[i].filename;
                    
                    var newFilename = newName;
                    if ( i > 0){
                        if (thisFiletype == "file"){
                            var thisFileExt = thisFilename.split(".").pop();
                            newFilename = newNameWithoutExt + "(" + i + ")." + thisFileExt;
                        }else if (thisFiletype == "folder"){
                            newFilename = newNameWithoutExt + "(" + i + ")";
                        }
                    }
                    srclist.push(thisFilepath);
                    newnamelist.push(newFilename);
                   
                }
                console.log(srclist, newnamelist);
                //Send the request to serverside
                $.ajax({
                    url: "../../system/file_system/fileOpr",
                    method: "POST",
                    data: {opr: "rename", src: JSON.stringify(srclist), new: JSON.stringify(newnamelist)},
                    success: function(data){
                        if (data.error !== undefined){
                            msgbox("remove",data.error);
                            $("#renameBox").fadeOut(100);
                        }else{
                            refreshList();
                            msgbox("checkmark","Rename suceed");
                            $("#renameBox").fadeOut(100);
                        }
                    }
                });
                renameFileObjects = [];
                hideAllPopupWindows();
            }

            function changeOverwriteRule(mode, doPasteAgain=false){
                switch (mode){
                    case 0:
                        overwriteMode = "overwrite";
                        break;
                    case 1:
                        overwriteMode = "skip";
                        break;
                    case 2:
                        overwriteMode = "keep";
                        break;
                    default:
                    overwriteMode = "keep";
                }

                if (doPasteAgain){
                    //Initiate paste without checking and close the overwritemode selector
                    paste(undefined, true);
                    $("#overwriteModeSelection").fadeOut(100);
                }
            }


            function copy(){
                cutMode = false;
                clipboard = [];
                if ($(".fileObject.selected").length == 0){
                    return;
                }
                $(".fileObject.selected").each(function(){
                    var thisFilepath = $(this).attr("filepath");
                    clipboard.push(thisFilepath);
                });
                if (useLocalstorage){
                    localStorage.setItem("ao/file_system/clipboard",JSON.stringify(clipboard));
                    localStorage.setItem("ao/file_system/cutmode","false");
                }
                msgbox("copy",clipboard.length + " objects copied.")
            }

            function cut(){
                cutMode = true;
                clipboard = [];
                if ($(".fileObject.selected").length == 0){
                    return;
                }
                $(".fileObject.selected").each(function(){
                    var thisFilepath = $(this).attr("filepath");
                    clipboard.push(thisFilepath);
                });
                if (useLocalstorage){
                    localStorage.setItem("ao/file_system/clipboard",JSON.stringify(clipboard));
                    localStorage.setItem("ao/file_system/cutmode","true");
                }
                msgbox("cut",clipboard.length + " objects ready to be moved.")
            }

            function paste(redirectPasteTarget="", nocheck=false){
                let thisOprCutMode = cutMode;
                let fileList = clipboard;
                let targetDir = currentPath;
                if (redirectPasteTarget != ""){
                    //Allow redirection of paste target if necessary
                    targetDir = redirectPasteTarget;
                }
                if (useLocalstorage){
                    //There are localStorage. Always use localStorage if exists.
                    var crossFrameClipboard = localStorage.getItem("ao/file_system/clipboard");
                    var useCutMode = localStorage.getItem("ao/file_system/cutmode");
                    if (crossFrameClipboard !== "" && crossFrameClipboard !== undefined && crossFrameClipboard !== null){
                        fileList = JSON.parse(crossFrameClipboard);
                    }
                    if (useCutMode !== "" && useCutMode !== undefined && useCutMode !== null){
                        thisOprCutMode = (useCutMode == "true");
                    }
                }
                if (fileList.length == 0){
                    //There are nothing to paste
                    msgbox("question","There are nothing to paste.")
                    return;
                }
                //console.log(fileList,JSON.stringify(fileList));
                if (thisOprCutMode == true){
                    //Cut and paste
                    $.ajax({
                        type: 'POST',
                        url: `../../system/file_system/validateFileOpr`,
                        data: {src: JSON.stringify(fileList), dest: targetDir},
                        success: function(data){
                           if (!nocheck && data !== null){
                               //There are problem with the copy target. Pop up overwrite rule selector
                                showDuplicateHandler(data);
                           }else{
                               //OK!
                               if (!ao_module_virtualDesktop){
                                   //Not under desktop mode. Use direct copy API
                                    $.ajax({
                                        type: 'POST',
                                        url: `../../system/file_system/fileOpr`,
                                        data: {opr: "move" ,src: JSON.stringify(fileList), dest: targetDir,existsresp: overwriteMode},
                                        success: function(data){
                                            if (data.error !== undefined){
                                                msgbox("remove",data.error);
                                            }else{
                                                //OK
                                                msgbox("checkmark",fileList.length + " objects moved.")
                                                refreshList();
                                            }
                                            hideAllPopupWindows();
                                        }
                                    });
                               }else{
                                    //Pass the request to operation handler
                                    var oprConfig = {
                                        opr: "move",
                                        src: fileList,
                                        dest: targetDir,
                                        overwriteMode: overwriteMode,
                                        callbackWindowID: ao_module_windowID,
                                        callbackFunction: `callRefresh("${targetDir}")`
                                    }
                                    var configHash = encodeURIComponent(JSON.stringify(oprConfig));
                                    var title = "Moving " + fileList.length;
                                    if (fileList.length > 1){
                                        title += " files";
                                    }else{
                                        title += " file";
                                    }
                                    parent.newFloatWindow({
                                        url: "SystemAO/file_system/file_operation.html#" + configHash,
                                        width: 400,
                                        height: 220,
                                        appicon: "SystemAO/file_system/img/selector.png",
                                        title: title
                                    });
                                    hideAllPopupWindows();
                               }
                           }
                        }
                    });
                }else{
                    //Copy and paste
                    //Check if the file list is OK for continue without the need for overwrite
                    $.ajax({
                        type: 'POST',
                        url: `../../system/file_system/validateFileOpr`,
                        data: {src: JSON.stringify(fileList), dest: targetDir},
                        success: function(data){
                           if (!nocheck && data !== null){
                               //There are problem with the copy target. Pop up overwrite rule selector
                                showDuplicateHandler(data);
                           }else{
                               //OK!
                               if (!ao_module_virtualDesktop){
                                    $.ajax({
                                        type: 'POST',
                                        url: `../../system/file_system/fileOpr`,
                                        data: {opr: "copy" ,src: JSON.stringify(fileList), dest: targetDir,existsresp: overwriteMode },
                                        success: function(data){
                                            if (data.error !== undefined){
                                                msgbox("remove",data.error);
                                            }else{
                                                //OK
                                                msgbox("checkmark",fileList.length + " objects copied.")
                                                refreshList();
                                            }
                                            hideAllPopupWindows();
                                        }
                                    });
                               }else{
                                    //Pass the request to operation handler
                                     //Pass the request to operation handler
                                     var oprConfig = {
                                        opr: "copy",
                                        src: fileList,
                                        dest: targetDir,
                                        overwriteMode: overwriteMode,
                                        callbackWindowID: ao_module_windowID,
                                        callbackFunction: `callRefresh("${targetDir}")`
                                    }
                                    var configHash = encodeURIComponent(JSON.stringify(oprConfig));
                                    var title = "Moving " + fileList.length;
                                    if (fileList.length > 1){
                                        title += " files";
                                    }else{
                                        title += " file";
                                    }
                                    parent.newFloatWindow({
                                        url: "SystemAO/file_system/file_operation.html#" + configHash,
                                        width: 400,
                                        height: 220,
                                        appicon: "SystemAO/file_system/img/selector.png",
                                        title: title
                                    });
                                    hideAllPopupWindows();
                               }
                               
                           }
                        }
                    });
                }
            }

            //Callback function for file operation display
            window.callRefresh = function(targetdir){
                console.log(currentPath, targetdir);
                if (currentPath == targetdir){
                    refreshList();
                }
            }

            //This action may duplicate files. Show handler
            function showDuplicateHandler(duplicateFileList){
                $(".popup").fadeOut(100);
                var duplicatedFileCounts = duplicateFileList.length;
                showPopupWrapper();
                $("#overwriteModeSelection").fadeIn(100);
                $("#overwriteModeSelection").find(".owm-fc").text(duplicatedFileCounts);
                var srcpath = duplicateFileList[0];
                srcpath = srcpath.split("/");
                srcpath.pop();
                srcpath = srcpath.join("/");
                $("#overwriteModeSelection").find(".owm-srcdir").text(srcpath);
                $("#overwriteModeSelection").find(".owm-destdir").text(currentPath);
            }

            //Force delete. Use normal delete fucntion if you want to move things to recycle bin instead.
            let forceDeleteList = [];
            function forceDelete(confirmed=false){
                if (confirmed == false){
                    //Show confirm box
                    let deletePendingList = [];
                    var listObject = $("#forceDeleteConfirmBox").find(".deleteFilelist")[0];
                    $(listObject).html("");
                    $(".selected.fileObject").each(function(data){
                        var thispath = $(this).attr("filepath");
                        var thisfilename = $(this).attr("filename");
                        var ext = thisfilename.split(".").pop();
                        var icon = ao_module_utils.getIconFromExt(ext);
                        deletePendingList.push(thispath);
                        $(listObject).append(`<div class="item ${currentTheme}" ><span style="display:inline-block;">${thisfilename}</span></div>`);
                    });
                    showPopupWrapper();
                    $("#forceDeleteConfirmBox").fadeIn(100);
                    forceDeleteList = deletePendingList;
                }else{
                    //Start force delete function
                    $("#forceDeleteConfirmBox").fadeOut(100);
                    let fdlistLength = forceDeleteList.length;
                    $.ajax({
                        url: "../../system/file_system/fileOpr",
                        method:"POST",
                        data: {opr: "delete", src: JSON.stringify(forceDeleteList)},
                        success: function(data){
                            if (data.error !== undefined){
                                msgbox("caution",data.error);
                            }else{
                                refreshList();
                                msgbox("checkmark",fdlistLength + " objects removed.")
                            }
                            hideAllPopupWindows();
                        }
                    });
                    //Finishing up delete sequence
                    forceDeleteList = [];
                }
            }

            let deleteFileList = [];
            function deleteFile(confirmed = false){
                if (!confirmed){
                    //Show the confirm dialog
                    $("#deleteConfirmBox").find(".deleteFilelist").html("");
                    $(".fileObject.selected").each(function(data){
                        var thisfilename = $(this).attr('filename');
                        var thisFilepath = $(this).attr('filepath');
                        deleteFileList.push(thisFilepath);
                        $("#deleteConfirmBox").find(".deleteFilelist").append(`<div class="item ${currentTheme}" ><span style="display:inline-block;">${thisfilename}</span></div>`);
                    });
                    if (deleteFileList.length == 0){
                        //No files selected
                        return;
                    }else{
                        //File selected. Continue to delete
                        showPopupWrapper();
                        $("#deleteConfirmBox").fadeIn(100);
                    }
                }else{
                    //Continue to delete files
                    let fdlistLength = deleteFileList.length;
                    $.ajax({
                        url: "../../system/file_system/fileOpr",
                        method:"POST",
                        data: {opr: "recycle", src: JSON.stringify(deleteFileList)},
                        success: function(data){
                            if (data.error !== undefined){
                                msgbox("caution",data.error);
                            }else{
                                refreshList();
                                msgbox("checkmark",fdlistLength + " objects moved to trash bin.")
                            }
                        }
                    });
                    console.log(deleteFileList);
                    deleteFileList = [];
                    hideAllPopupWindows();
                }
            }

            function cancelDelete(){
                deleteFileList=[];
                
            }

            function cancelForceDelete(){
                $("#forceDeleteConfirmBox").fadeOut(100);
                forceDeleteList = [];
            }

            function upload(){
                var input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.onchange = e => { 
                    var files = e.target.files; 
                    msgbox("upload","Upload Started");
                    for (var i = 0; i < files.length; i++){
                        uploadFile(files[i]);
                    }
                }
                input.click();
            }


            function updatePathDisplay(path){
                var pathInfo = path.split("/");
                var vdID = pathInfo[0];
                //As path always end with /, pop the empty pathinfo from array
                pathInfo.pop();
                var l = pathInfo.length;
                //Append the starting vdir
                $(".pathDisplay").html("");
                $(".pathDisplay").append(`<div class="section ${currentTheme} selectable" onclick="rootDir();"><i class="folder icon"></i> ${vdID}</div>`);
                $(".pathDisplay").append(`<div class="divider ${currentTheme} whiteTheme">/</div>`);
                //console.log(pathInfo);
                if (l > 3){
                    //E.g. user:/Desktop/test/boo/ => Display as user:/.../test/boo/
                    $(".pathDisplay").append(`<div class="section ${currentTheme}">...</div>`);
                    $(".pathDisplay").append(`<div class="divider ${currentTheme} whiteTheme">/</div>`);
                    $(".pathDisplay").append(`<div class="section ${currentTheme} selectable"  onclick="parentDir();">${pathInfo[l-2]}</div>`);
                    $(".pathDisplay").append(`<div class="divider ${currentTheme} whiteTheme">/</div>`);
                    $(".pathDisplay").append(`<div class="section ${currentTheme} selectable" onclick="refreshList();">${pathInfo[l-1]}</div>`);
                }else if (l == 3){
                    $(".pathDisplay").append(`<div class="section ${currentTheme} selectable"  onclick="parentDir();">${pathInfo[l-2]}</div>`);
                    $(".pathDisplay").append(`<div class="divider ${currentTheme} whiteTheme">/</div>`);
                    $(".pathDisplay").append(`<div class="section ${currentTheme} selectable" onclick="refreshList();">${pathInfo[l-1]}</div>`);
                }else if (l == 2){
                    //E.g. user:/Desktop or user:/
                    $(".pathDisplay").append(`<div class="section ${currentTheme} selectable" onclick="refreshList();">${pathInfo[1]}</div>`);
                }
            }

            function getExtFromPath(path){
                if (path.includes(".") == false){
                    return "";
                }
                return path.split(".").pop();
            }

            function getFileObjectFromFID(fid){
                var targetFileObject = null;
                $(".fileObject").each(function(){
                    if ($(this).attr("fileid") == fid){
                        targetFileObject = $(this);
                    }
                });
                return targetFileObject;
            }

            function openViaButton(){
                let fileOpenList = [];
                let foldersToBeOpened=[];
                $(".fileObject.selected").each(function(){
                    let type = $(this).attr("type");
                    let filepath = $(this).attr("filepath");
                    if (type == "file"){
                        fileOpenList.push(filepath);
                    }else if (type == "folder"){
                        foldersToBeOpened.push(filepath);
                    }
                });
                //Open files
                openPathWithDefaultOpener(fileOpenList);

                //Open folders
                openFolderInNewWindow(foldersToBeOpened);
            }

            function openthis(object,evt=null){
                if (evt !== null){
                    evt.preventDefault();
                }
                var objType = $(object).attr("type");
                if ( objType == "file"){
                    //Open this file. Generate the access path from filepath
                    var filepath = $(object).attr("filepath");
                    //Only one path to be opened. Pass in as a single object array
                    openPathWithDefaultOpener([filepath]);
                }else if (objType == "folder"){
                    //Open this folder
                    var folderPath = $(object).attr('filepath');
                    listDirectory(folderPath);
                }

                //Check if this opened in sidebar and in mobile mode. Close sidebar if yes
                if ($(object).hasClass('dir') && isMobile){
                    toggleSidebar();
                }
            }

            //Download the selected files.
            function downloadFile(){
                var fileList = [];
                if ($(".fileObject.selected").length == 1 && $(".fileObject.selected").attr("type") == "file"){
                    //One file. Download directly.
                    var downloadURL = "/media?file=" + encodeURIComponent($(".fileObject.selected").attr("filepath")) + "&download=true";
                    var filename = $(".fileObject.selected").attr("filename");
                    generateDownloadFromURL(downloadURL,escape(filename));
                }else{
                    //Do zip and download for multiple files
                    $(".fileObject.selected").each(function(){
                        fileList.push($(this).attr("filepath"));
                    });
                    console.log(fileList);
                    //Zip the file or folder
                    $.ajax({
                        url: "../../system/file_system/zipHandler",
                        data: {opr: "tmpzip", src: JSON.stringify(fileList), dest: ""},
                        method: "POST",
                        success: function(data){
                            if (data.error !== undefined){
                                alert(data.error);
                            }else{
                                //Zip completed.
                                window.open("../../media?file=" + data + "&download=true");
                            }
                        }
                    });
                    
                }
                
            }

            //Create a new file
            function newfile(){
                $(".popup").fadeOut('fast');
                showPopupWrapper();
                $("#newFile").fadeIn('fast');
                $("#newFile").find(".duplicateWarning").hide();
                $("#createNewFileName").parent().removeClass("error");
                //Update the newfile list
                $("#newFile").find(".newfilelist").html("");
                $.ajax({
                    url: "../../system/file_system/newItem",
                    success: function(data){
                        if (data.error !== undefined){
                            return;
                        }
                        for (var i =0; i < data.length; i++){
                            var desc = data[i].Desc;
                            var ext = data[i].Ext;
                            var icon = ao_module_utils.getIconFromExt(ext);
                            $("#newFile").find(".newfilelist").append(`<div class="item newFileFormat" ext="${ext}"><i class="${icon} icon" style="margin-right:12px;"></i> ${desc}</div>`);
                        }
                        //Initialize the new file as txt
                        var filename = "newfile";
                        var finalFilename = filename; 
                        var i = 0;
                        while (currentFilelist.includes(finalFilename)){
                            finalFilename = finalFilename + "(" + i + ")";
                            i++;
                        }  
                        $("#createNewFileName").val(finalFilename + ".txt");

                        //Hook events for on click
                        $(".newFileFormat").off("click").on("click",function(data){
                            $(".newFileFormat").removeClass("selected");
                            $(this).addClass("selected");

                            //Parse the newfilename
                            var selectedExt = $(this).attr("ext");
                            var filename = "newfile";
                            var finalFilename = filename; 
                            var i = 0;
                            while (currentFilelist.includes(finalFilename)){
                                finalFilename = finalFilename + "(" + i + ")";
                                i++;
                            }  
                            $("#createNewFileName").val(filename + "." + selectedExt);
                        });
                    }
                });
            }

            function newFolder(confirmed = false){
                if (confirmed == false){
                    //Launch the dialog for newFolder
                    $(".popup").fadeOut(100);
                    $("#createNewFolder").val("");
                    $("#createNewFolder").parent().removeClass("error").removeClass("success");
                    $("#newFolder").find(".duplicateWarning").hide();
                    showPopupWrapper();
                    $("#newFolder").fadeIn(100);
                }else{
                    //Create new folder
                    var newFoldername = $("#createNewFolder").val();
                    if (newFoldername == ""){
                        $("#createNewFolder").parent().addClass("error");
                        return;
                    }
                    if (currentFilelist.includes(newFoldername)){
                        //Current filelist already contain a folder with the same name
                        $("#createNewFolder").parent().addClass("error");
                        $("#newFolder").find(".duplicateWarning").show();
                        return;
                    }
                    //OK to proceed.
                    $("#createNewFolder").parent().removeClass("error").addClass("success");
                    $("#newFolder").find(".duplicateWarning").hide();
                    $.ajax({
                        url: "../../system/file_system/newItem",
                        data: {type: "folder", src: currentPath, filename: newFoldername},
                        success: function(data){
                            if (data.error !== undefined){
                                msgbox("remove", data.error);
                            }else{
                                msgbox("checkmark","New folder created.");
                                refreshList();
                            }
                            $("#newFolder").fadeOut('fast');
                            hideAllPopupWindows();
                        }
                    });
                }
            }

            function confirmNewFile(){
                var filename = $("#createNewFileName").val();
                if (filename == ""){
                    //Filename not set
                    $("#createNewFileName").parent().addClass("error");
                    return;
                }else if(currentFilelist.includes(filename)){
                    //File with this name already exists
                    $("#createNewFileName").parent().addClass("error");
                    $("#newFile").find(".duplicateWarning").show();
                    return;
                }
                $("#createNewFileName").parent().removeClass("error");
                //Ok to proceed
                $.ajax({
                    url: "../../system/file_system/newItem",
                    data: {type: "file", src: currentPath, filename:filename},
                    success: function(data){
                        if (data.error !== undefined){
                            msgbox("remove",data.error);
                        }else{
                            msgbox("checkmark",filename + " created.");
                            refreshList();
                        }
                    }
                });
                hideAllPopupWindows();
                $("#newFile").fadeOut('fast');
            }

            //OpenWith dialog
            function openWith(){
                if ($(".selected.fileObject").length == 0){
                    msgbox("question","No file selected");
                    return;
                }
                //Get a list of modules and append it into the selection list
                $.get("../../system/modules/list",function(data){
                    if (data.error !== undefined){
                        console.log(data.error);
                    }else{
                        $("#openWithModuleList").html("");
                        for (var i =0; i < data.length; i++){
                            var thisModule = data[i];
                            var supportFW = `<div class="ts horizontal mini label"><i class="checkmark icon"></i>floatWindow Window</div>`;
                            var supportEmb = `<div class="ts horizontal mini label"><i class="checkmark icon"></i>Embedded Window</div>`;
                            if (!thisModule.SupportFW){
                                supportFW = "";
                            }
                            if (!thisModule.LaunchEmb){
                                supportEmb = "";
                            }
                            var launchInfo = encodeURIComponent(JSON.stringify(thisModule));
                            $("#openWithModuleList").append(`<div class="item selectable openWithModule" launchInfo="${launchInfo}" onclick="selectOpenWithModule(this, event);" ondblclick="selectOpenWithModule(this, event); openWithSelectedModule();">
                                <img class="ts avatar image" src="../../${thisModule.IconPath}">
                                <div class="content" style="padding-left:12px;">
                                    <div class="header">${thisModule.Name}</div>
                                    <div class="description">
                                        ${supportFW}
                                        ${supportEmb}
                                    </div>
                                </div>
                            </div>`);
                        }
                    }
                });
                $(".openWithModule.popupbuttons").addClass("disabled");

                if (!ao_module_virtualDesktop){
                    $("#openWith").find(".vdonly").hide();
                }
                showPopupWrapper();
                $("#openWith").fadeIn('fast');

            }

            //Functions for handling open with module selection and file opening
            function selectOpenWithModule(object, event){
                event.preventDefault();
                $(".openWithModule.popupbuttons").removeClass("disabled");
                $(".openWithModule.selected").removeClass("selected");
                $(object).addClass("selected");
            }

            function openWithSelectedModule(btn){
                if ($(btn).hasClass("disabled")){
                    return false;
                }
                var targetModuleInfo = JSON.parse(decodeURIComponent($(".openWithModule.selected").attr("launchInfo")));
                var targetObjects = $(".selected.fileObject");
                console.log(targetModuleInfo);

                //Phrase launch mode from the module info
                var launchURL = targetModuleInfo.StartDir
                var launchSize = [undefined, undefined];
                var iconPath = targetModuleInfo.IconPath;
                var title = targetModuleInfo.Name;
                if (targetModuleInfo.SupportEmb){
                    //Launch with embedded mode
                    launchURL = targetModuleInfo.LaunchEmb;
                    if (targetModuleInfo.InitEmbSize !== null){
                        launchSize = targetModuleInfo.InitEmbSize
                    }
                   
                }else if (targetModuleInfo.SupportFW){
                    //Launch with floatWindow mode
                    launchURL = targetModuleInfo.LaunchFWDir;
                    if (targetModuleInfo.InitFWSize !== null){
                        launchSize = targetModuleInfo.InitFWSize
                    }
                }else if (targetModuleInfo.StartDir !== ""){
                    //Launch with default mode

                }else{
                    msgbox("remove","This module has no endpoint for opening a file.");
                    return;
                }   

                //Parse the filelist
                var filelist = [];
                $(targetObjects).each(function(){
                    var filename = $(this).attr("filename");
                    var filepath = $(this).attr("filepath");
                    filelist.push({
                        filename: filename,
                        filepath: filepath
                    });
                });

                fileHash = encodeURIComponent(JSON.stringify(filelist));
                if (ao_module_virtualDesktop){
                    //Open the target module in a new fw
                    parent.newFloatWindow({
                        url: launchURL + "#" + fileHash,
                        width: launchSize[0],
                        height: launchSize[1],
                        appicon: iconPath,
                        title: title
                    });
                }else{
                    //Redirect current window to the target module
                    window.location.href = "../../" + launchURL + "#" + fileHash;
                }

                hideAllPopupWindows();
            }

            function openFileWithModuleInNewTab(btn){
                if ($(btn).hasClass("disabled")){
                    return false;
                }
                var targetModuleInfo = JSON.parse(decodeURIComponent($(".openWithModule.selected").attr("launchInfo")));
                var targetObjects = $(".selected.fileObject");

                //Parse the filelist
                var filelist = [];
                $(targetObjects).each(function(){
                    var filename = $(this).attr("filename");
                    var filepath = $(this).attr("filepath");
                    filelist.push({
                        filename: filename,
                        filepath: filepath
                    });
                });

                //Directly passing the file information to the startdir
                fileHash = encodeURIComponent(JSON.stringify(filelist));
                window.open("../../" + targetModuleInfo.StartDir + "#" + fileHash);
                hideAllPopupWindows();
            }

            function openRawFileInFloatWindow(btn){
                //Directly open this (or more than one) files / folder in floatWindow
                var targetObjects = $(".selected.fileObject");
                $(targetObjects).each(function(){
                    if ($(this).attr("type") == "file"){
                        var launchURL = "media?file=" + $(this).attr('filepath');
                        parent.newFloatWindow({
                            url: launchURL,
                            appicon: "img/system/file.png",
                            title: $(this).attr('filename'),
                            "background-color": "#1f1f1f"
                        });
                    }else if ($(this).attr("type") == "folder"){
                        var launchURL = "SystemAO/file_system/file_explorer.html#" + $(this).attr("filepath");
                        parent.newFloatWindow({
                            url: launchURL,
                            appicon: "SystemAO/file_system/img/small_icon.png",
                            title: "File Manager - "  + $(this).attr('filename'),
                        });
                    }else{
                        //Not supported openeing type.
                        console.log("Failed to open file " + $(this).attr('filepath') + " . WIP")
                    }
                });
                hideAllPopupWindows();
            }

            //Open the filepaths in the given paramters
            function openPathWithDefaultOpener(filepaths){
                console.log(filepaths);
                for (var i =0; i < filepaths.length; i++){
                    var filepath = filepaths[i];
                    var ext = "." + filepath.split(".").pop();
                    $.ajax({
                        url: "../../system/modules/getDefault",
                        method: "GET",
                        data: {opr: "launch", ext: ext, mode: "launch"},
                        success: function(data){
                            if (data.error !== undefined){
                                //No default opener assigned. Launch it with opener selector
                                //alert("Open Default Opener Selector, WIP");
                                var url = "SystemAO/file_system/defaultOpener.html";
                                var icon = "SystemAO/file_system/img/opener.png";
                                var title = "Select an opener WebApp: "
                                var openFileList = [];
                                var openFileObject = {
                                    filepath: filepath,
                                    filename: filepath.split("/").pop()
                                }
                                openFileList.push(openFileObject);
                                var openParamter = encodeURIComponent(JSON.stringify(openFileObject));
                                var ao_module_virtualDesktop = !(!parent.isDesktopMode);
                                console.log(window.innerHeight/2 - 510/20);
                                if (ao_module_virtualDesktop){
                                    parent.newFloatWindow({
                                        url: url + "#" + openParamter,
                                        width: 320,
                                        height: 510,
                                        appicon: icon,
                                        title: title
                                    });
                                }else{
                                    url = "defaultOpener.html";
                                    window.open(url + "#" + openParamter);
                                }
                            }else{
                                //Assigned. Launch with given paramter
                                var url = data["StartDir"];
                                var size = [undefined, undefined];
                                var title = data["Name"];
                                var icon = "img/system/favicon.png";
                                if (data["IconPath"] != ""){
                                    icon = data["IconPath"];
                                }
                                //Use floatWindow if exists
                                if (data["SupportFW"] == true && data["LaunchFWDir"] != ""){
                                    url = data["LaunchFWDir"];
                                    if (data["InitFWSize"] !== null){
                                        size = data["InitFWSize"]
                                    }
                                }
                                //Use embedded mode if exists
                                if (data["SupportEmb"] == true && data["LaunchEmb"] != ""){
                                    url = data["LaunchEmb"];
                                    if (data["InitEmbSize"] !== null){
                                        size = data["InitEmbSize"]
                                    }
                                }

                                //Build open File Hash Data Format
                                var openFileList = [];
                                var openFileObject = {
                                    filepath: filepath,
                                    filename: filepath.split("/").pop()
                                }
                                openFileList.push(openFileObject);
                                var openParamter = encodeURIComponent(JSON.stringify(openFileList));
                                
                                //Add launch files info and launch floatWindow
                                var ao_module_virtualDesktop = !(!parent.isDesktopMode);
                                if (ao_module_virtualDesktop){
                                    parent.newFloatWindow({
                                        url: url + "#" + openParamter,
                                        width: size[0],
                                        height: size[1],
                                        appicon: icon,
                                        title: title
                                    });
                                }else{
                                    window.open("../../" + url + "#" + openParamter);
                                }
                                
                            }
                        }
                    });
                }
            }

            //Always open the first object locally, and open others in new floatWindows
            function openFolderInNewWindow(path){
                if (path.length > 0){
                    listDirectory(path[0]);
                    for (var i = 1; i < path.length; i++){
                        newFloatWindow(location.href.replace(location.hash,"") + "#" + path[i])
                    }
                }
            }

            //Preference setting and loading functions.
            function setPreference(key, value){
                $.ajax({
                    url:"../../system/file_system/preference?key=" + key + "&value=" + value,
                    success: function(data){
                        if (data.error !== undefined){
                            console.log(data);
                        }
                    }
                });
            }

            function loadPreference(key, callback){
                $.get("../../system/file_system/preference?key=" + key,function(data){
                    callback(data);
                });
            }

            // ============================== WINDOW RESIZE FUNCTIONS =====================
            $(document).ready(function(data){
                if (window.innerWidth < 620 && !isMobile){
                    toggleSidebar(false);
                }
                initWindowSizes(false);
            });

            $(window).on("resize",function(){
                initWindowSizes(false);
                if (!isMobile && window.innerWidth < 620 && sideBarShown == true){
                    toggleSidebar(false);
                }else if (!isMobile && window.innerWidth > 650 && sideBarShown == false){
                    toggleSidebar(false);
                }
            });

            

            function toggleSidebar(useAnimation=true){
                //Fixing desktop bugs on showing the sidebar
                if (isMobile){
                    $("#directorySidebar").stop().finish().animate({left: "toggle"},200);
                }else{
                    if ($("#directorySidebar").offset().left < 0){
                        $("#directorySidebar").stop().finish().animate({left: 0},200);
                    }else{
                        $("#directorySidebar").stop().finish().animate({left: -1 * directorySidebarWidth},200);
                    }
                }
               
                sideBarShown = !sideBarShown;
                initWindowSizes(useAnimation);
            }

            function initWindowSizes(animate=true){
                var h = $("#navibar").css("height");
                var hint = $("#navibar").height();
                //$("#mainWindow").css("padding-top",h);
                var windowHeight = window.innerHeight - hint - 12;
                //console.log(windowHeight);
                if (sideBarShown){
                    //Resize the sidebar 
                    $("#directorySidebar").css("top",h);
                    $("#directorySidebar").css("width",directorySidebarWidth);
                    $("#directorySidebar").css("height",windowHeight + "px");
                    //Resize the file viewer
                    $("#folderView").css("top",h);
                    if (window.innerWidth > 650){
                        if (animate){
                            $("#folderView").stop().finish().animate({
                                left: directorySidebarWidth + 'px',
                                width: window.innerWidth - directorySidebarWidth - 2 + "px"
                            },200);
                        }else{
                            $("#folderView").css({
                                left: directorySidebarWidth + 'px',
                                width: window.innerWidth - directorySidebarWidth - 2 + "px"
                            });
                        }
                    }else{
                        //Window width too small to allow resizing sidebar shown. Overlap it
                        if (animate){
                            $("#folderView").stop().finish().animate({
                                left: directorySidebarWidth + 'px',
                                width: window.innerWidth + "px"
                            },200);
                        }else{
                            $("#folderView").css({
                                left: directorySidebarWidth + 'px',
                                width: window.innerWidth + "px"
                            });
                        }
                    }
                   
                    if (isChromium){
                        //$("#mainWindow").css("height", window.innerWidth);
                    }
                    //$("#folderView").css("left",directorySidebarWidth + "px");
                    $("#folderView").css("height",windowHeight + "px");
                }else{
                    $("#folderView").css("top",h);
                    if (animate){
                        $("#folderView").stop().finish().animate({
                            left:'0px',
                            width:(window.innerWidth - 2 + "px")
                        },200);
                    }else{
                        $("#folderView").css({
                            left:'0px',
                            width:(window.innerWidth - 2 + "px")
                        });
                    }
                    $("#folderView").css("height",windowHeight + "px");
                    
                }
            }

            function toggleDarkTheme(){
                if ($(".darkTheme").length > 0){
                    $(".darkTheme").removeClass("darkTheme").addClass("whiteTheme");
                    currentTheme = "whiteTheme";
                    $("#darkthemebtn").attr("class","moon icon");
                    $("#darkthemebtn").parent().addClass("inverted");
                    setPreference("file_explorer/theme","whiteTheme");
                }else{
                    $(".whiteTheme").removeClass("whiteTheme").addClass("darkTheme");
                    currentTheme = "darkTheme";
                    $("#darkthemebtn").attr("class","sun icon");
                    $("#darkthemebtn").parent().removeClass("inverted");
                    setPreference("file_explorer/theme","darkTheme");
                }
               
            }

            function msgbox(icon, text){
                $($(".msgbox").find("span")[0]).text(text);
                $($(".msgbox").find("i")[0]).attr("class", icon + " icon");
                $(".msgbox").stop().finish().slideDown('fast').delay(3000).slideUp('fast');
            }

            //Keyboard hotkey events
            $(document).keydown(function(event){
                if(event.which==17){
                    ctrlHold = true;
                }else if (event.which == 16){
                    shiftHold = true;
                }else if (event.which == 67 && ctrlHold == true){
                    //Ctrl + C
                    if (!$(".popup").is(":visible")){
                        copy();
                    } 
                }else if (event.which == 88 && ctrlHold == true){
                    //Ctrl + X
                    if (!$(".popup").is(":visible")){
                        cut();
                    } 
                }else if (event.which == 86 && ctrlHold == true){
                    if (!$(".popup").is(":visible")){
                        paste();
                    } 
                }else if (event.which == 46 && shiftHold == true){
                    //Shift + delete
                    forceDelete();
                }else if (event.which == 46){
                    //Delete
                    deleteFile();
                }else{
                    //console.log(event.which);
                }
            });

            $(document).keyup(function(event){
                if(event.which==17){
                    ctrlHold = false;
                }else if (event.which == 16){
                    shiftHold = false;
                }
            });

            $("#directorySidebar").on("click",function(evt){
                //Clear the button holding
                $(".fileObject.selected").removeClass("selected");
                shiftHold = false;
                ctrlHold = false;
            });

            //Check if localstorage is availble
            function lscheck(){
                var test = 'test';
                try {
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch(e) {
                    return false;
                }
            }

            //Handle drag drop upload
           function drop(event){
                event.preventDefault();
                console.log(event, event.target)
                //Check if this is file upload or file move / copy function

                let dt = event.dataTransfer
                let files = dt.files
                if (files.length > 0){
                    //Upload file via dragdrop
                    msgbox("upload","Upload Started");
                    for (var i =0; i < files.length; i++){
                        uploadFile(files[i]);
                    }
                    
                }else{
                    //File transfer within system
                    console.log(event);
                }
           }

        function showFileProperties(){
            //Show the file list of the selected files
            if ($(".fileObject.selected").length > 0){
                //Build the filelist
                var fileList = [];
                $(".fileObject.selected").each(function(){
                    var filepath = $(this).attr("filepath");
                    fileList.push(filepath);
                });
            }

            var hashPassthrough = encodeURIComponent(JSON.stringify(fileList));
            ao_module_newfw({
                url: "SystemAO/file_system/file_properties.html#" + hashPassthrough,
                width: 340,
                height: 480,
                appicon: "SystemAO/file_system/img/properties.png",
                title: "File Properties",
            });
        }

        function uploadFile(file) {
            let url = '../../system/file_system/upload'
            let uploadCurrentPath = currentPath;
            let formData = new FormData()
            let xhr = new XMLHttpRequest()
            formData.append('file', file);
            formData.append('path', currentPath);
            //Append this file to the upload progress list
            let taskUUID = appendUploadFileItem(file.name, file.size);
            xhr.open('POST', url, true)
            xhr.upload.addEventListener("progress", function(e) {
                progress = (e.loaded * 100.0 / e.total) || 100;
                $(".uploadTask").each(function(){
                    if ($(this).attr("taskID") == taskUUID){
                        //Update this progress bar
                        $(this).find(".bar").css("width",progress + "%");

                        if (progress == 100){
                            //When progress = 100 and the server is not response with 200,
                            //That means the upload has finish and server is processing the upload
                            $(this).find(".progress").addClass("indeterminate");
                        }
                    }
                });
            })

            xhr.addEventListener('readystatechange', function(e) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    //Upload process ended
                    if (uploadCurrentPath == currentPath){
                        $(".uploadTask").each(function(){
                            if ($(this).attr("taskID") == taskUUID){
                                //Update this progress bar to completed
                                $(this).find(".bar").css("width","100%");
                                $(this).find(".progress").attr("class","ts tiny positive progress");
                                $(this).find(".uploadTaskRemoveIcon").show();
                                $(this).addClass("ended");
                            }
                        });
                        setTimeout(refreshList,500);
                    }
                    var resp = JSON.parse(e.target.response);
                    if (resp.error !== undefined){
                        msgbox("caution",resp.error);
                        //Something went wrong. Set the color to red
                        $(".uploadTask").each(function(){
                            if ($(this).attr("taskID") == taskUUID){
                                //Update this progress bar to completed
                                $(this).find(".bar").css("width","100%");
                                $(this).find(".progress").attr("class","ts tiny negative progress");
                                $(this).find(".uploadTaskRemoveIcon").show();
                                $(this).addClass("ended");
                            }
                        });
                    }
                    uploadingFileCount--;
                }else if (xhr.readyState == 4 && xhr.status != 200) {
                    msgbox("remove","File too big or the target disk is fulled");
                    console.log(xhr);
                    $(".uploadTask").each(function(){
                        if ($(this).attr("taskID") == taskUUID){
                            //Upload screwed up. Show negative
                            $(this).find(".progress").attr("class","ts tiny negative progress");
                            $(this).find(".uploadTaskRemoveIcon").show();
                            $(this).addClass("ended");
                        }
                    });
                    uploadingFileCount--;
                }
                updateUploadFileCount();
            })

            xhr.send(formData);
            uploadingFileCount++;
            updateUploadFileCount();
        }

        //Clear all finished upload tasks
        function clearAllUploadTask(){
            $(".uploadTask.ended").slideUp('300',function(){
                $(this).remove();
                updateUploadFileCount();
            });
            
        }

        function appendUploadFileItem(filename, filesize){
            var newuuid = uuidv4();
            var humanReadableFilesize = bytesToSize(filesize);
            $("#uploadProgressList").append(`<div class="uploadTask" taskID="${newuuid}">
                <p style="width: calc(100% - 15px);">${filename} (${humanReadableFilesize})</p>
                <div class="ts tiny primary progress" style="margin-top:-12px;">
                    <div class="bar" style="width: 0%"></div>
                </div>
                <div class="uploadTaskRemoveIcon" onclick="removeThisTask(this);" style="display:none;">
                    <i class="remove icon"></i>
                </div>
            </div>`);
            return newuuid;
        }

        function removeThisTask(object){
            $(object).parent().fadeOut('fast',
                function(){
                    $(this).remove();
                    updateUploadFileCount();
                }
            );
            
        }

        function toggleUploadList(){
            $("#uploadProgressList").toggle();
            if ($("#uploadProgressList").is(":visible")){
                $("#hideUploadButton").html('<i class="caret down icon"></i>');
            }else{
                $("#hideUploadButton").html('<i class="caret up icon"></i>');
            }
        }

        function updateUploadFileCount(){
            $("#uploadCount").text(uploadingFileCount);
            if (uploadingFileCount == 0 && $(".uploadTask").length == 0){
                $("#uploadTab").hide();
            }else{
                $("#uploadTab").show();
            }
        }

        function bytesToSize(bytes) {
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            if (bytes == 0) return '0 Byte';
            var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i) * 100, 2) / 100 + ' ' + sizes[i];
        }

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

           function dropToFolder(event){
                event.preventDefault();
                event.stopImmediatePropagation();
                console.log("Drop to folder detected");
           }

           function allowDrop(event){
                event.preventDefault();
           }

           $(".popupWrapper").on("click",function(){
                hideAllPopupWindows();
           });

           function hideAllPopupWindows(){
               $(".popup").fadeOut(100);
               $(".popupWrapper").fadeOut(100);
               $('body').css("overflow","");
           }

           function showPopupWrapper(){
                $(".popupWrapper").fadeIn('fast');
                $('body').css("overflow","hidden");
           }

           //Handle keydown of enter on certain input boxes
           function handleEnterKeyDown(event, handler){
                if (event.which == 13){
                    handler();
                }
           }

           //Generate a download link and press it
           function generateDownloadFromURL(url, filename){
                let a = document.createElement('a')
                a.href = url;
                a.download = filename;
                document.body.appendChild(a)
                a.click()
                document.body.removeChild(a)
            }
           //Handle new window opening
           function newFloatWindow(url){
               //Use floatwindow if it exists
               //WIP
               window.open(url);
           }

        </script>
    </body>
</html>